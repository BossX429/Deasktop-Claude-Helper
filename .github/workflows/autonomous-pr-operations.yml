name: Autonomous PR Operations

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted, edited]

jobs:
  # Request reviews from maintainers when AI/Copilot PR is created
  request-reviews:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'opened' &&
      (contains(github.head_ref, 'copilot/') || contains(github.head_ref, 'ai/') || github.actor == 'github-actions')
    permissions:
      pull-requests: write
    steps:
      - name: Request reviews from maintainers
        uses: actions/github-script@v7
        with:
          script: |
            const maintainers = ['BossX429']; // Add maintainer usernames here
            const pr = context.payload.pull_request;

            if (maintainers.length > 0) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  reviewers: maintainers
                });
                console.log(`‚úÖ Review requested from: ${maintainers.join(', ')}`);
              } catch (error) {
                console.log(`‚ö†Ô∏è  Could not request reviews: ${error.message}`);
              }
            }

      - name: Add info comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const isAIGen =
              pr.title.includes('[AI]') ||
              pr.title.includes('Copilot') ||
              pr.body?.includes('AI agent') ||
              ['copilot/', 'ai/'].some(prefix => context.payload.pull_request?.head?.ref?.startsWith(prefix));

            if (isAIGen) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ü§ñ **AI-Generated PR Detected**\n\n` +
                  `This PR was automatically created. Once all checks pass and a maintainer approves, it will automatically merge.\n\n` +
                  `**Status checks required:**\n` +
                  `- ‚úÖ \`smoke-tests\` must pass\n\n` +
                  `**See also:**\n` +
                  `- [Copilot Instructions](.github/copilot-instructions.md)\n` +
                  `- [PR Template](.github/PULL_REQUEST_TEMPLATE.md)`
              });
            }

  # Auto-merge when all conditions are met
  auto-merge-on-approval:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.state == 'APPROVED' &&
      (contains(github.event.pull_request.head.ref, 'copilot/') ||
       contains(github.event.pull_request.head.ref, 'ai/') ||
       github.event.pull_request.user.login == 'github-actions')
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Check if all required checks pass
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const requiredChecks = ['smoke-tests'];
            const checksByName = {};
            const checkDetails = {};

            checks.check_runs.forEach(run => {
              checksByName[run.name] = run.status === 'completed' && run.conclusion === 'success';
              checkDetails[run.name] = {
                status: run.status,
                conclusion: run.conclusion,
                completed: run.status === 'completed',
                success: run.status === 'completed' && run.conclusion === 'success'
              };
            });

            const allPassed = requiredChecks.every(name => checksByName[name] === true);
            const approvalCount = pr.review_comments; // Count approvals

            // Enhanced debugging information
            console.log('üìä Check Status Report:');
            console.log('='.repeat(50));
            console.log(`Required checks: ${requiredChecks.join(', ')}`);
            console.log('\nDetailed status:');
            for (const checkName of requiredChecks) {
              const details = checkDetails[checkName];
              if (details) {
                console.log(`  ‚Ä¢ ${checkName}:`);
                console.log(`    - Status: ${details.status}`);
                console.log(`    - Conclusion: ${details.conclusion || 'N/A'}`);
                console.log(`    - Passed: ${details.success ? '‚úÖ' : '‚ùå'}`);
              } else {
                console.log(`  ‚Ä¢ ${checkName}: ‚ö†Ô∏è  Not found or not started yet`);
              }
            }
            console.log('='.repeat(50));
            console.log(`\nAll required checks passed: ${allPassed ? '‚úÖ YES' : '‚ùå NO'}`);

            if (!allPassed) {
              console.log('\n‚è≥ Not all required checks have passed yet');
              console.log('‚ÑπÔ∏è  This is normal - checks may still be running or pending.');
              console.log('‚ÑπÔ∏è  Auto-merge will be enabled once all checks pass.');
              
              // Post informative comment to PR
              const pendingChecks = requiredChecks.filter(name => !checksByName[name]);
              const commentBody = `‚è≥ **Auto-merge pending**\n\n` +
                `Waiting for the following checks to complete:\n` +
                pendingChecks.map(name => {
                  const details = checkDetails[name];
                  if (!details) {
                    return `- \`${name}\`: Not started yet`;
                  } else if (details.status !== 'completed') {
                    return `- \`${name}\`: ${details.status}`;
                  } else {
                    return `- \`${name}\`: ${details.conclusion}`;
                  }
                }).join('\n') +
                `\n\nOnce all checks pass, auto-merge will be enabled automatically.`;

              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('‚úÖ Posted status comment to PR');
              } catch (error) {
                console.log(`‚ö†Ô∏è  Could not post comment: ${error.message}`);
              }
              
              // Exit gracefully without failing the job
              console.log('\n‚úÖ Exiting gracefully - job will retry when checks update');
              return;
            }

            console.log('\n‚úÖ All checks passed! Ready for auto-merge');

      - name: Enable auto-merge (squash)
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'REQUEST_CHANGES'
              });
            } catch (e) {
              // Ignore if we can't comment
            }

            // Use GraphQL to enable auto-merge
            const mutation = `
              mutation {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: "${context.payload.pull_request.node_id}",
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                      enabledBy {
                        login
                      }
                      mergeMethod
                    }
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(mutation);
              if (result.enablePullRequestAutoMerge.pullRequest.autoMergeRequest) {
                console.log('‚úÖ Auto-merge enabled for this PR');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `üöÄ **Auto-merge enabled!**\n\n` +
                    `This PR will automatically merge once all checks pass.`
                });
              }
            } catch (error) {
              console.log(`Note: Auto-merge setup: ${error.message}`);
            }

  # Label AI-generated PRs
  label-ai-prs:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    permissions:
      pull-requests: write
    steps:
      - name: Add AI-generated label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const isAI =
              pr.head.ref?.includes('copilot/') ||
              pr.head.ref?.includes('ai/') ||
              pr.body?.includes('AI agent') ||
              pr.title.includes('[AI]');

            if (isAI) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['ai-generated']
                });
                console.log('‚úÖ Added ai-generated label');
              } catch (error) {
                console.log(`Label may not exist yet: ${error.message}`);
              }
            }

  # Enforce branch protection rules
  enforce-branch-protection:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    permissions:
      pull-requests: write
    steps:
      - name: Enforce branch protection rules
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = 'main'; // Change this to your default branch if different

            // Define the required status checks and their contexts
            const requiredStatusChecks = ['smoke-tests'];

            try {
              // Get the current branch protection settings
              const { data: protection } = await github.rest.repos.getBranchProtection({
                owner,
                repo,
                branch
              });

              // Check if the required status checks are already set
              const existingChecks = protection.required_status_checks?.contexts || [];
              const checksToAdd = requiredStatusChecks.filter(check => !existingChecks.includes(check));

              if (checksToAdd.length > 0) {
                // Update branch protection to require the missing status checks
                await github.rest.repos.updateBranchProtection({
                  owner,
                  repo,
                  branch,
                  required_status_checks: {
                    strict: true,
                    contexts: [...existingChecks, ...checksToAdd]
                  },
                  enforce_admins: true,
                  required_pull_request_reviews: {
                    dismiss_stale_reviews: true,
                    require_code_owner_reviews: true,
                    required_approving_review_count: 1
                  },
                  restrictions: null // Remove any existing restrictions
                });

                console.log(`‚úÖ Updated branch protection rules for ${branch}: ${checksToAdd.join(', ')} checks added`);
              } else {
                console.log(`‚ÑπÔ∏è  No updates needed for branch protection rules on ${branch}`);
              }
            } catch (error) {
              console.log(`Error managing branch protection: ${error.message}`);
            }

  # AI PR Operation Flow
  ai-pr-operation-flow:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'opened' &&
      (contains(github.head_ref, 'copilot/') || contains(github.head_ref, 'ai/'))
    steps:
      - name: AI PR Operation Steps
        run: |
          echo "1. AI Agent: git push -u origin copilot/fix-xxx"
          echo "2. GitHub: PR created, tests triggered automatically"
          echo "3. System: Review requested, label added"
          echo "4. Maintainer: Reviews code, clicks 'Approve'"
          echo "5. System: Auto-merge triggered ‚Üí PR merges automatically ‚úÖ"
